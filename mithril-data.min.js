/**
 * mithril-data v0.0.1
 * A rich model framework for Mithril application.
 * 
 * (c) 2016 Kevin Villanueva
 * License: MIT
 */
!function(t){function n(o){if(e[o])return e[o].exports;var i=e[o]={exports:{},id:o,loaded:!1};return t[o].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var e={};return n.m=t,n.c=e,n.p="",n(0)}([function(t,n,e){function o(t){function n(n,e){var o=n||{},i=(t.refs,t.props);-1===r.indexOf(i,c.keyId)&&i.push(c.keyId),h.call(this);for(var s,u=0;u<i.length;u++){if(s=i[u],!this.__isProp(s)||"id"===s&&s!==c.keyId)return;if(r.hasIn(this,s)&&"id"!==s)throw new Error("`"+s+"` prop is not allowed.");this[s]=this.__gettersetter(r.isUndefined(o[s])?t.defaults[s]:o[s],s)}e&&this.opt(e)}i(t);var e=a.isConflictExtend(h.prototype,t.methods);if(e)throw new Error("`"+e+"` method is not allowed.");return n.modelOptions=t,n.prototype=r.create(h.prototype,r.assign(t.methods||{},{options:t})),Object.setPrototypeOf(n,d.prototype),n}function i(t){t.defaults=t.defaults||{},t.props=r.union(t.props||[],r.keys(t.defaults)),t.refs=t.refs||{}}var s,r=e(1),u=e(2),c=e(3).config,l=e(3).modelConstructors,h=e(4),d=e(8),a=e(6),f=e(7);n.version=function(){return"v0.0.1"},n.Collection=e(7),n.store=e(5),n.model=function(t,n){if(t=t||{},n=n||{},!t.name)throw new Error("Model name must be set.");var e=l[t.name]=o(t);return e.__init(n),e},n.model.get=function(t){return l[t]},n.config=function(t){r.assign(c,t),c.modelMethods&&a.strictExtend(h.prototype,c.modelMethods),c.constructorMethods&&a.strictExtend(d.prototype,c.constructorMethods),c.collectionMethods&&a.strictExtend(f.prototype,c.collectionMethods),c.modelMethods=null,c.constructorMethods=null,c.collectionMethods=null},n.resetConfig=function(){for(var t in c)delete c[t];n.config({baseUrl:"",keyId:"id",store:u.request,redraw:!1})},n.resetConfig(),s=function(){return n}.call(n,e,n,t),!(void 0!==s&&(t.exports=s)),"undefined"!=typeof window&&(n.noConflict=function(){return oldObject&&(window.md=oldObject,oldObject=null),window.md},window.__TEST__&&window.mocha&&window.chai&&(n.__TEST__={config:c,BaseModel:h,ModelConstructor:d}),window.md&&(oldObject=window.md),window.md=n)},function(t,n){t.exports=_},function(t,n){t.exports=m},function(t,n){n.config={},n.modelConstructors={}},function(t,n,e){function o(){this.__options={redraw:!1},this.__collections=[],this.__cid=i.uniqueId("model"),this.__saved=!1,this.__json={__model:this},i.bindAll(this,i.union(d,r.modelBindMethods))}var i=e(1),s=e(2),r=e(3).config,u=e(3).modelConstructors;t.exports=o;var c=e(5),l=e(6),h=e(7),d=[],a={has:1,keys:0,values:0,pick:1,omit:1};o.prototype={opt:function(t,n){i.isPlainObject(t)?i.assign(this.__options,t):this.__options[t]=n||!0},id:function(t){return t?this[r.keyId](t):this[r.keyId]()},cid:function(){return this.__cid},url:function(){return r.baseUrl+(this.options.url||"/"+this.options.name.toLowerCase())},attachCollection:function(t){if(!(t instanceof h))throw new Error("Argument `collection` must be instance of Collection.");var n=t.get(this);n&&-1===i.indexOf(this.__collections,t)?this.__collections.push(t):t.add(this)},detachCollection:function(t){if(!(t instanceof h))throw new Error("Argument `collection` must be instance of Collection.");t.get(this)&&t.remove(this),i.indexOf(this.__collections,t)>-1&&i.pull(this.__collections,t)},set:function(t,n,e){var s=t instanceof o;if(s||i.isPlainObject(t)){for(var r,u,c=i.keys(t),l=c.length-1;l>=0;l--){if(r=c[l],u=t[r],!this.__isProp(r)||!i.isFunction(this[r]))return;s&&i.isFunction(u)?this[r](u(),!0):this[r](u,!0)}n||this.__update()}else this[t](arguments[1],e)},get:function(t){return t?this[t]():this.getCopy()},getJson:function(){return this.__json},getCopy:function(t){for(var n,e,s={},r=i.keys(this.__json),u=0;u<r.length;u++)n=r[u],e=this.__json[n],this.__isProp(n)&&(e&&e.__model instanceof o?s[n]=e.__model.get():s[n]=e);return t?i.cloneDeep(s):s},save:function(t){var n=this,e=s.deferred(),o=this.id()?c.put:c.post;return o.call(c,this.url(),this).then(function(o){n.set(o),n.__saved=!0,e.resolve(n),i.isFunction(t)&&t(null,n)},function(n){e.reject(n),i.isFunction(t)&&t(n)}),e.promise},fetch:function(t){var n=this,e=s.deferred(),o=this.__getDataId();return o[r.keyId]?c.get(this.url(),o).then(function(o){n.set(o),n.__saved=!0,e.resolve(n),i.isFunction(t)&&t(null,n)},function(n){e.reject(n),i.isFunction(t)&&t(n)}):(e.reject(!0),i.isFunction(t)&&t(!0)),e.promise},destroy:function(t){var n=this,e=s.deferred(),o=this.__getDataId();return o[r.keyId]?c.destroy(this.url(),o).then(function(o){n.detach(),e.resolve(),i.isFunction(t)&&t(null),n.dispose()},function(n){e.reject(n),i.isFunction(t)&&t(n)}):(e.reject(!0),i.isFunction(t)&&t(!0)),e.promise},remove:function(){this.detach(),this.dispose()},detach:function(){for(var t=i.clone(this.__collections),n=0;n<t.length;n++)t[n].remove(this),t[n]=null},dispose:function(){var t,n=i.keys(this),e=this.options.props;for(this.__json.__model=null,t=0;t<e.length;t++)this[e[t]](null);for(t=0;t<n.length;t++)this[n[t]]=null},isSaved:function(){return this.__saved},isNew:function(){return!(this.id()&&this.__saved)},__update:function(t){var n;(this.__options.redraw||this.options.redraw||r.redraw)&&(s.startComputation(),n=!0);for(var e=0;e<this.__collections.length;e++)this.__collections[e].__update(this);n&&s.endComputation()},__isProp:function(t){return i.indexOf(this.options.props,t)>-1},__getDataId:function(){var t={};return t[r.keyId]=this.id(),t},__gettersetter:function(t,n){function e(){var t;return arguments.length?(t=arguments[0],i.isPlainObject(t)&&r&&(t=new u[r](t)),t instanceof o&&(t=t.getJson()),s[n]=t,arguments[1]||this.__update(n),t):(t=s[n],t&&t.__model instanceof o&&(t=t.__model),t)}var s=this.__json,r=this.options.refs[n];return e.toJSON=function(){return s[n]},e(t,!0),e}},l.addMethods(o.prototype,i,a,"__json")},function(t,n,e){function o(t,n){c.storeConfigXHR&&c.storeConfigXHR(t,n),t.setRequestHeader("Content-Type","application/json")}function i(t,n){return c.storeExtract?c.storeExtract(t,n):t.responseText.length?t.responseText:null}function s(t){return t=t instanceof l?t.getCopy():t,c.storeSerializer?c.storeSerializer(t):JSON.stringify(t)}function r(t){if(c.storeDeserializer)return c.storeDeserializer(t);try{return JSON.parse(t)}catch(n){return t}}var u=e(1),c=e(3).config,l=e(4);t.exports=u.create(null,{request:function(t,n,e,l){var h={method:n||"GET",url:t,data:e||{},serialize:s,deserialize:r,config:o,extract:i};return l&&u.assign(h,l),c.storeConfigOptions&&c.storeConfigOptions(h),c.store(h)},get:function(t,n,e){return this.request(t,"GET",n,e)},post:function(t,n,e){return this.request(t,"POST",n,e)},put:function(t,n,e){return this.request(t,"PUT",n,e)},destroy:function(t,n,e){return this.request(t,"DELETE",n,e)}})},function(t,n,e){function o(t,n){return function(e,o,i,s){return t(e?e[n]||e:e,o?o[n]||o:o,i,s)}}function i(t,n){for(var e,i=t.length-1;i>=0;i--)e=t[i],r.isFunction(e)?t[i]=o(e,n):e instanceof c&&(t[i]=e.__json);return t}function s(t,n,e){if(t===n)return t;if(r.isArray(t)){for(var o,i=t.length-1;i>=0;i--)o=t[i],o&&o[e]&&(t[i]=o[e]);return t}return t?t[e]||t:t}var r=e(1),u=Array.prototype.slice,c=e(4);t.exports=r.create(null,{hasValueOfType:function(t,n){for(var e=r.keys(t),o=0;o<e.length;o++)if(t[e[o]]instanceof n)return!0;return!1},isConflictExtend:function(t,n,e){for(var o=r.keys(n),i=0;i<o.length;i++)if(r.hasIn(t,o[i]))return o[i];return!1},strictExtend:function(t,n){var e=this.isConflictExtend(t,n);if(e)throw new Error("`"+e+"` method / property is not allowed.");r.extend(t,n)},addMethods:function(t,n,e,l,h){r.each(e,function(e,d){if(n[d])switch(e){case 0:t[d]=function(){return s(n[d](this[l]),this[l],h)};break;case 1:t[d]=function(t){return r.isFunction(t)?t=o(t,h):t instanceof c&&(t=t.__json),s(n[d](this[l],t),this[l],h)};break;case 2:t[d]=function(t,e){return r.isFunction(t)?t=o(t,h):t instanceof c&&(t=t.__json),r.isFunction(e)?e=o(e,h):e instanceof c&&(e=e.__json),s(n[d](this[l],t,e),this[l],h)};break;default:t[d]=function(){var t=i(u.call(arguments),h);return t.unshift(this[l]),s(n[d].apply(n,t),this[l],h)}}})}})},function(t,n,e){function o(t){this.models=[],this.__options={redraw:!1},t&&this.opt(t),i.bindAll(this,i.union(l,u.collectionBindMethods))}var i=e(1),s=e(2),r=e(6),u=e(3).config,c=e(4);t.exports=o,o.prototype={opt:function(t,n){i.isPlainObject(t)?i.assign(this.__options,t):this.__options[t]=n||!0},add:function(t,n,e){if(!(t instanceof c)||this.__options.model&&!(t instanceof this.__options.model))throw new Error("Must be a model or an instance of set model");var o=this.get(t),i=!1;return o?o.set(t):(n?this.models.unshift(t.getJson()):this.models.push(t.getJson()),t.attachCollection(this),i=!0),i&&!e&&this.__update(),i},addAll:function(t,n,e){i.isArray(t)||(t=[t]);for(var o=!1,s=0;s<t.length;s++)this.add(t[s],n,!0)&&(o=!0);return o&&!e&&this.__update(),o},create:function(t){i.isArray(t)||(t=[t]);for(var n,e,o=[],s=0;s<t.length;s++){if(e=t[s],!i.isPlainObject(e))throw new Error("Plain object required");n=this.get(e),n?n.set(e):this.__options.model&&o.push(new this.__options.model(e))}return this.addAll(o),o},get:function(t){var n;if(t instanceof c)return this.indexOf(t.getJson())>-1?t:void 0;if(i.isObject(t)){if(!t[u.keyId])return this.find(t)||void 0;t=t[u.keyId]}return n=this.find([u.keyId,t]),n||void 0},getAll:function(t,n){i.isArray(t)||(t=[t]);for(var e,o=[],s=0;s<t.length;s++)e=this.get(t[s]),(e||n)&&o.push(e);return o},remove:function(t,n){i.isArray(t)||(t=[t]);var e,o,s,r=this.size(),l=[];if(r){for(s=0;s<t.length;s++){if(o=t[s],!o)throw new Error("Can't remove from collection. Argument must be set.");o instanceof c?l.push.apply(l,i.remove(this.models,function(t){return i.eq(t,o.getJson())})):i.isObjectLike(o)?l.push.apply(l,i.remove(this.models,function(t){return i.isMatch(t,o)})):l.push.apply(l,i.remove(this.models,function(t){return e={},e[u.keyId]=o,i.isMatch(t,e)}))}for(s=0;s<l.length;s++)l[s].__model.detachCollection(this);return r!==this.size()?(n||this.__update(),!0):!1}},push:function(t,n){return this.addAll(t,n)},unshift:function(t,n){return this.addAll(t,!0,n)},shift:function(t){var n=this.first();return this.remove(n,t),n},pop:function(t){var n=this.last();return this.remove(n,t),n},clear:function(t){return this.remove(this.toArray(),t)},pluck:function(t){for(var n=[],e=0,o=this.models;e<o.length;e++)n.push(o[e][t]);return n},dispose:function(){var t=i.keys(this),n=0;for(this.__options.model&&(this.__options.model=null);n<t.length;n++)this[t[n]]=null},destroy:function(){this.clear(!0),this.dispose()},hasModel:function(){return!!this.__options.model},model:function(){return this.__options.model},url:function(t){var n=t?"":u.baseUrl;return this.__options.url?n+=this.__options.url:this.hasModel()&&(n+=this.model().modelOptions.url||"/"+this.model().modelOptions.name.toLowerCase()),n},fetch:function(t,n,e){i.isFunction(n)&&(e=n,n=void 0);var o=s.deferred();if(this.hasModel){var r=this;this.model().pull(this.url(),t,n).then(function(t){r.addAll(t),o.resolve(r),i.isFunction(e)&&e(null,r)},function(t){o.reject(t),i.isFunction(e)&&e(t)})}else o.reject(!0),i.isFunction(e)&&e(!0);return o.promise},__update:function(){(this.__options.redraw||u.redraw)&&(s.startComputation(),s.endComputation())}};var l=[],h={forEach:1,map:1,find:1,findIndex:1,findLastIndex:1,filter:1,reject:1,every:1,some:1,invoke:3,maxBy:1,minBy:1,sortBy:1,groupBy:1,shuffle:0,size:0,initial:0,without:1,indexOf:2,lastIndexOf:2,difference:1,sample:0,reverse:0,nth:1,first:0,last:0,toArray:0,slice:1,orderBy:2,transform:2};r.addMethods(o.prototype,i,h,"models","__model")},function(t,n,e){function o(){}var i=e(5),s=e(7);t.exports=o,o.prototype={__init:function(t){this.__options||(this.__options={redraw:!1},t&&this.opt(t))},__flagSaved:function(t){for(var n=0;n<t.length;n++)t[n].__saved=!0},opt:function(t,n){this.__options||this.__init(),_.isPlainObject(t)?_.assign(this.__options,t):this.__options[t]=n||!0},createCollection:function(t){return new s(_.assign({model:this},t))},createModels:function(t){_.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++){if(!_.isPlainObject(t[n]))throw new Error("Plain object required");t[n]=new this(t[n])}return t},pull:function(t,n,e,o){_.isFunction(n)?(o=n,n=void 0):_.isFunction(e)&&(o=e,e=void 0);var s=this,r=m.deferred();return i.get(t,n,e).then(function(t){var n=s.createModels(t);s.__flagSaved(n),r.resolve(n),_.isFunction(o)&&o(null,n)},function(t){r.reject(t),_.isFunction(o)&&o(t)}),r.promise}}}]);