/**
 * mithril-data v0.0.2
 * A rich model framework for Mithril application.
 * 
 * (c) 2016 Kevin Villanueva
 * License: MIT
 */
!function(t){function n(i){if(e[i])return e[i].exports;var o=e[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="",n(0)}([function(t,n,e){function o(t,n,e,i){1===arguments.length&&y.isFunction(t)&&!t.then?(i=t,t=null):2===arguments.length?(i=n,n=null):3===arguments.length&&(i=e,e=null);var o=w.prop(t);return i?function(t,s){var r,u=j.call(arguments),c=n&&n.options&&n.options.refs?n.options.refs:{};if(y.isObjectLike(t)&&y.has(c,e)){var l=F[c[e]].collection.get(t);l?l.set(t):l=new F[c[e]](t)||null,u[0]=t=l}return r=o.apply(null,u),u.length&&!s&&i.call(n,t,e),r}:o}function s(){k.methods&&u(p.prototype,k.methods),k.controllerMethods&&u(d.prototype,k.controllerMethods)}function r(t,n,e){var i,o=!1;return y.each(y.keys(n),function(n){y.hasIn(t,n)&&(o||(o=!0,i=n))}),o?i:o}function u(t,n){var e=r(t,n);if(e)throw new Error("`"+e+"` method / property is not allowed.");y.extend(t,n)}function c(t,n){return function(e,i,o,s){return t(e?e[n]||e:e,i?i[n]||i:i,o,s)}}function l(t,n){for(var e,i=t.length-1;i>=0;i--)e=t[i],y.isFunction(e)?t[i]=c(e,n):e instanceof p&&(t[i]=e.__json);return t}function a(t,n,e){if(t===n)return t;if(y.isArray(t)){for(var i,o=t.length-1;o>=0;o--)i=t[o],i&&i[e]&&(t[o]=i[e]);return t}return t?t[e]||t:t}function h(t,n,e,i,o){y.each(e,function(e){if(n[e])switch(n[e].length){case 1:t[e]=function(){return a(n[e](this[i]),this[i],o)};break;case 2:t[e]=function(t){return y.isFunction(t)?t=c(t,o):t instanceof p&&(t=t.__json),a(n[e](this[i],t),this[i],o)};break;case 3:t[e]=function(t,s){return y.isFunction(t)?t=c(t,o):t instanceof p&&(t=t.__json),y.isFunction(s)?s=c(s,o):s instanceof p&&(s=s.__json),a(n[e](this[i],t,s),this[i],o)};break;default:t[e]=function(){var t=l(j.call(arguments),o);return t.unshift(this[i]),a(n[e].apply(n,t),this[i],o)}}})}function f(t){this.models=[],this.__options={redraw:!1},t&&this.opt(t),y.bindAll(this,O)}function d(){}function p(){this.__options={redraw:!1},this.__collections=[],this.__cid=y.uniqueId("model"),this.__saved=!1,y.bindAll(this,A)}function _(t){function n(n){var e,i=this,s=n||{},r=t.refs||{},u=t.props||[],c=t.defaults||{};-1===y.indexOf(u,k.keyId)&&u.push(k.keyId),p.call(this),u&&y.isArray(u)&&y.each(u,function(t){if(i.isProp(t)&&("id"!==t||t===k.keyId)){if(y.hasIn(i,t)&&"id"!==t)throw new Error("`"+t+"` property field is not allowed.");y.isObjectLike(s[t])&&y.has(r,t)?(e=F[r[t]].collection.get(s[t]),e?(e.set(s[t]),i[t]=o(e,i,t,i.changed)):i[t]=o(new F[r[t]](s[t])||null,i,t,i.changed)):i[t]=o(s[t]||c[t]||null,i,t,i.changed)}}),y.has(this,k.keyId)||(this[k.keyId]=o()),F[this.options.name].collection.add(this)}m(t);var e=r(p.prototype,t.methods);if(e)throw new Error("`"+e+"` method is not allowed.");return n.modelOptions=t,n.prototype=y.create(p.prototype,y.assign(t.methods||{},{options:t})),Object.setPrototypeOf(n,d.prototype),n}function m(t){t.props=y.union(t.props,y.keys(t.defaults))}var v,g,y=e(1),w=e(2),j=Array.prototype.slice,F={},k={baseUrl:"",keyId:"id",redraw:!1,store:w.request};Object.setPrototypeOf=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t};var I=y.create({request:function(t,n,e,i){var o={method:t,url:n,data:e||{},serialize:this.serializer,deserialize:this.deserializer,config:this.config,extract:this.extract};return i&&y.assign(o,i),k.storeConfigOptions&&k.storeConfigOptions(o),k.store(o)},config:function(t,n){k.storeConfigXHR&&k.storeConfigXHR(t,n),t.setRequestHeader("Content-Type","application/json")},extract:function(t,n){return k.storeExtract?k.storeExtract(t,n):t.responseText.length?t.responseText:null},serializer:function(t){return t=t instanceof p?t.getCopy():t,k.storeSerializer?k.storeSerializer(t):JSON.stringify(t)},deserializer:function(t){return k.storeDeserializer?k.storeDeserializer(t):JSON.parse(t)},get:function(t,n,e){return this.request("GET",t,n,e)},post:function(t,n,e){return this.request("POST",t,n,e)},put:function(t,n,e){return this.request("PUT",t,n,e)},"delete":function(t,n,e){return this.request("DELETE",t,n,e)}});f.prototype={opt:function(t,n){y.isPlainObject(t)?y.assign(this.__options,t):this.__options[t]=n||!0},changed:function(){(this.__options.redraw||k.redraw)&&w.redraw()},add:function(t,n,e){if(!(t instanceof p)||this.__options.model&&!(t instanceof this.__options.model))throw new Error("Can't add to collection. Argument must be a model or an instance of set model.");var i=this.get(t),o=!1;return i?i.set(t):(n?this.models.unshift(t.getJson()):this.models.push(t.getJson()),t.addCollection(this),o=!0),o&&!e&&this.changed(),o},addAll:function(t,n,e){y.isArray(t)||(t=[t]);var i=this,o=!1;return y.each(t,function(t){i.add(t,n,!0)&&(o=!0)}),o&&!e&&this.changed(),o},get:function(t){var n;if(t instanceof p)return this.indexOf(t.getJson())>-1?t:null;if(y.isObjectLike(t)){if(!t[k.keyId])return this.find(t)||null;t=t[k.keyId]}return n=this.find([k.keyId,t]),n||null},getAll:function(t,n){y.isArray(t)||(t=[t]);var e,i=this,o=[];return y.transform(t,function(t,o){e=i.get(o),(e||n)&&t.push(e)},o),o},remove:function(t,n){y.isArray(t)||(t=[t]);var e,i=this,o=this.size(),s=[];return o?(y.each(t,function(t){if(!t)throw new Error("Can't remove from collection. Argument must be set.");t instanceof p?s.push.apply(s,y.remove(i.models,function(n){return y.eq(n,t.getJson())})):y.isObjectLike(t)?s.push.apply(s,y.remove(i.models,function(n){return y.isMatch(n,t)})):s.push.apply(s,y.remove(i.models,function(n){return e={},e[k.keyId]=t,y.isMatch(n,e)}))}),y.each(s,function(t){t.__model.removeCollection(i)}),o===this.size()||n||this.changed(),this.size()):void 0},push:function(t,n){return this.addAll(t,n)},unshift:function(t,n){return this.addAll(t,!0,n)},shift:function(t){var n=this.first();return this.remove(n,t),n},pop:function(t){var n=this.last();return this.remove(n,t),n},clear:function(t){this.remove(this.toArray(),t)},pluck:function(t){var n=[];return this.transform(function(n,e){n.push(e[t]())},n),n},destroy:function(){this.clear(!0),this.dispose()},dispose:function(){var t=y.keys(this),n=0;for(this.__options.model&&(this.__options.model=null);n<t.length;n++)this[t[n]]=null},hasModel:function(){return!!this.__options.model},model:function(){return this.__options.model},url:function(t){var n=t?"":k.baseUrl;return this.__options.url?n+=this.__options.url:this.hasModel()&&(n+=this.model().modelOptions.url||"/"+this.model().modelOptions.name.toLowerCase()),n},fetch:function(t,n,e){y.isFunction(n)&&(e=n,n=null);var i=w.deferred();if(this.hasModel){var o=this;this.model().pull(this.url(),t,n).then(function(t){o.addAll(t),i.resolve(t),y.isFunction(e)&&e(null,t)},function(t){i.reject(t),y.isFunction(e)&&e(t)})}else i.reject(!0),y.isFunction(e)&&e(!0);return i.promise},fetchById:function(t,n,e){y.isFunction(n)&&(e=n,n=null);var i=this,o=w.deferred();return this.hasModel?Model.Note.pullById(t,n).then(function(t){i.addAll(t),o.resolve(t),y.isFunction(e)&&e(null,t)},function(t){o.reject(t),y.isFunction(e)&&e(t)}):(o.reject(!0),y.isFunction(e)&&e(!0)),o.promise}};var O=["add","addAll"],b=["forEach","map","find","findIndex","findLastIndex","filter","reject","every","some","invoke","maxBy","minBy","sortBy","groupBy","shuffle","size","initial","without","indexOf","lastIndexOf","difference","sample","reverse","nth","first","last","toArray","slice","orderBy","transform"];h(f.prototype,y,b,"models","__model"),d.prototype={__init:function(t){this.__options||(this.__options={redraw:!1},t&&this.opt(t))},__flagSaved:function(t){for(i=0;i<t.length;i++)t[i].__saved=!0},opt:function(t,n){this.__options||this.__init(),y.isPlainObject(t)?y.assign(this.__options,t):this.__options[t]=n||!0},create:function(t){y.isArray(t)||(t=[t]);var n,e=this,i=[];return y.transform(t,function(t,i){if(!y.isPlainObject(i))throw new Error("Can't create model to collection. Argument must be a plain object.");n=e.collection.get(i),n?(n.set(i),t.push(n)):t.push(new e.collection.__options.model(i))},i),i},createCollection:function(t){return new f(y.assign({model:this},t))},loadById:function(t,n,e){if(y.isFunction(n)&&(e=n,n=null),!t)throw new Error("Collection can't fetch. Id must be set.");y.isArray(t)||(t=[t]);var i=this,o=w.deferred(),s=[];this.collection.transform(function(t,n){n.id()&&t.push(n.id())},s);var r=y.pullAll(t,s);return y.isEmpty(r)?(o.resolve(),y.isFunction(e)&&e(null)):I.get(this.collection.url(),r,n).then(function(t){i.__flagSaved(i.create(t)),o.resolve(),y.isFunction(e)&&e(null)},function(t){o.reject(t),y.isFunction(e)&&e(t)}),o.promise},pullById:function(t,n,e){y.isFunction(n)&&(e=n,n=null);var i=this,o=w.deferred();return y.isArray(t)||(t=[t]),this.loadById(t,n).then(function(){var n=i.collection.getAll(t);o.resolve(n),y.isFunction(e)&&e(null,n)},function(t){o.reject(t),y.isFunction(e)&&e(t)}),o.promise},pull:function(t,n,e,i){y.isFunction(n)?(i=n,n=null):y.isFunction(e)&&(i=e,e=null);var o=this,s=w.deferred();return I.get(t,n,e).then(function(t){var n=o.create(t);o.__flagSaved(n),s.resolve(n),y.isFunction(i)&&i(null,n)},function(t){s.reject(t),y.isFunction(i)&&i(t)}),s.promise}},p.prototype={id:function(t){return t?this[k.keyId](t):this[k.keyId]()},cid:function(){return this.__cid},url:function(){return k.baseUrl+(this.options.url||"/"+this.options.name.toLowerCase())},addCollection:function(t){if(!(t instanceof f))throw new Error("Argument `collection` must be instance of Collection.");var n=t.get(this);n&&-1===y.indexOf(this.__collections,t)?this.__collections.push(t):t.add(this)},removeCollection:function(t){if(!(t instanceof f))throw new Error("Argument `collection` must be instance of Collection.");t.get(this)&&t.remove(this),y.indexOf(this.__collections,t)>-1&&y.pull(this.__collections,t)},changed:function(t,n){t||n?this.updateJson(n):this.updateJson(),(this.__options.redraw||this.options.redraw||k.redraw)&&w.redraw(),y.each(this.__collections,function(t){t.changed(this)})},set:function(t,n){var e,i=this,o=this.options.refs||{},s=t instanceof p;s||y.isPlainObject(t)?(y.each(t,function(t,n){if(i.isProp(n)&&y.isFunction(i[n]))if(y.isObjectLike(t)&&y.has(o,n))e=F[o[n]].collection.get(t),e?(e.set(t),i[n](e,!0)):i[n](new F[o[n]](t)||null,!0);else if(s&&y.isFunction(t)){if(n===k.keyId&&i.id())return;i[n](t(),!0)}else i[n](t||null,!0)}),this.changed()):this[t](n||null)},updateJson:function(t){var n=this;if(this.__json||(this.__json={},this.__json.__model=this),t){if(!this.isProp(t))return;var e=this[t]();this.__json[t]=e instanceof p?e.getJson():e}else y.each(this,function(t,e){n.isProp(e)&&y.isFunction(t)&&(t=t(),t&&!y.isNull(t)&&(n.__json[e]=t instanceof p?t.getJson():t))})},get:function(t){return t?this[t]():this.getCopy()},getJson:function(){return this.__json||this.updateJson(),this.__json},getCopy:function(){var t=this,n={};return y.each(this.getJson(),function(e,i){t.isProp(i)&&(e.__model&&e.__model instanceof p?n[i]=e.__model.get():n[i]=e)}),n},opt:function(t,n){y.isPlainObject(t)?y.assign(this.__options,t):this.__options[t]=n||!0},save:function(t){var n=this,e=w.deferred(),i=this.id()?I.put:I.post;return i.call(I,this.url(),this).then(function(i){n.set(i),n.__saved=!0,e.resolve(n),y.isFunction(t)&&t(null,n)},function(n){e.reject(n),y.isFunction(t)&&t(n)}),e.promise},fetch:function(t){var n=this,e=w.deferred(),i=this.__getDataId();return i[k.keyId]?I.get(this.url(),i).then(function(i){n.set(i),n.__saved=!0,e.resolve(n),y.isFunction(t)&&t(null,n)},function(n){e.reject(n),y.isFunction(t)&&t(n)}):(e.reject(!0),y.isFunction(t)&&t(!0)),e.promise},remove:function(t,n){var e=this,i=w.deferred(),o=function(t){for(var o=y.clone(e.__collections),s=0;s<o.length;s++)o[s].remove(e),o[s]=null;i.resolve(),y.isFunction(n)&&n(null)};if(t===!0)o(),this.dispose();else{n=t;var s=this.__getDataId();s[k.keyId]?I["delete"](this.url(),s).then(o,function(t){i.reject(t),y.isFunction(n)&&n(t)}):(i.reject(!0),y.isFunction(n)&&n(!0))}return i.promise},isSaved:function(){return this.__saved},isNew:function(){return!(this.id()&&this.__saved)},isProp:function(t){return y.indexOf(this.options.props,t)>-1},dispose:function(){var t,n=y.keys(this),e=this.options.props;for(t=0;t<e.length;t++)this[e[t]](null);for(t=0;t<n.length;t++)this[n[t]]=null},__getDataId:function(){var t={};return t[k.keyId]=this.id(),t}};var A=["save","remove"],x=["has","keys","values","invert","pick","omit"];h(p.prototype,y,x,"__json"),n.Collection=f,n.prop=o,n.request=I,n.model=function(t,n){if(t=t||{},n=n||{},!t.name)throw new Error("Model name must be set.");var e=F[t.name]=_(t);return e.__init(n),e.collection=new f({model:e}),e},n.config=function(t){y.assign(k,t),s()},n.noConflict=function(){return g&&(window.md=g,g=null),window.md},n.version=function(){return"v0.0.2"},v=function(){return n}.call(n,e,n,t),!(void 0!==v&&(t.exports=v)),"undefined"!=typeof window&&(window.md&&(g=window.md),window.md=n)},function(t,n){t.exports=_},function(t,n){t.exports=m}]);