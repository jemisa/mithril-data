/**
 * mithril-data v0.0.1
 * A rich model framework for Mithril application.
 * 
 * (c) 2016 Kevin Villanueva
 * License: MIT
 */
!function(t){function n(i){if(e[i])return e[i].exports;var o=e[i]={exports:{},id:i,loaded:!1};return t[i].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="",n(0)}([function(t,n,e){function i(t,n,e,i){var o=g.prop(t);return 2===arguments.length?(i=n,n=null):3===arguments.length&&(i=e,e=null),i?function(t,r){var s,c=w.call(arguments),u=n.options.refs;if(y.isObjectLike(t)&&y.has(u,e)){var l=j[u[e]].get(t);l?l.set(t):l=new j[u[e]](t)||null,c[0]=t=l}return s=o.apply(null,c),c.length&&!r&&i.call(n,t,e),s}:o}function o(){b.methods&&c(p.prototype,b.methods),b.controllerMethods&&c(d.prototype,b.controllerMethods)}function r(){return("000000"+(Math.random()*Math.pow(36,6)<<0).toString(36)).slice(-6)}function s(t,n,e){var i,o=!1;return y.each(y.keys(n),function(n){y.hasIn(t,n)&&(o||(o=!0,i=n))}),o?i:o}function c(t,n){var e=s(t,n);if(e)throw new Error("`"+e+"` method / property is not allowed.");y.extend(t,n)}function u(t,n){return function(e,i,o,r){return t(e?e[n]||e:e,i?i[n]||i:i,o,r)}}function l(t,n){for(var e,i=t.length-1;i>=0;i--)e=t[i],y.isFunction(e)?t[i]=u(e,n):e instanceof p&&(t[i]=e.__json);return t}function a(t,n,e){if(t===n)return t;if(y.isArray(t)){for(var i,o=t.length-1;o>=0;o--)i=t[o],i&&i[e]&&(t[o]=i[e]);return t}return t?t[e]||t:t}function h(t,n,e,i,o){y.each(e,function(e){if(n[e])switch(n[e].length){case 1:t[e]=function(){return a(n[e](this[i]),this[i],o)};break;case 2:t[e]=function(t){return y.isFunction(t)?t=u(t,o):t instanceof p&&(t=t.__json),a(n[e](this[i],t),this[i],o)};break;case 3:t[e]=function(t,r){return y.isFunction(t)?t=u(t,o):t instanceof p&&(t=t.__json),y.isFunction(r)?r=u(r,o):r instanceof p&&(r=r.__json),a(n[e](this[i],t,r),this[i],o)};break;default:t[e]=function(){var t=l(w.call(arguments),o);return t.unshift(this[i]),a(n[e].apply(n,t),this[i],o)}}})}function f(t){this._init(t),y.bindAll(this,A)}function d(){}function p(){this.__options={redraw:!1},this.__collections=[],this.__cid=r(),y.bindAll(this,I)}function _(t){function n(n){var e,o=this,r=n||{},s=t.refs||{},c=t.props||[],u=t.defaults||{};-1===y.indexOf(c,b.keyId)&&c.push(b.keyId),p.call(this),c&&y.isArray(c)&&y.each(c,function(t){if(o.isProp(t)&&("id"!==t||t===b.keyId)){if(y.hasIn(o,t)&&"id"!==t)throw new Error("`"+t+"` property field is not allowed.");y.isObjectLike(r[t])&&y.has(s,t)?(e=j[s[t]].get(r[t]),e?(e.set(r[t]),o[t]=i(e,o,t,o.changed)):o[t]=i(new j[s[t]](r[t])||null,o,t,o.changed)):o[t]=i(r[t]||u[t]||null,o,t,o.changed)}}),y.has(this,b.keyId)||(this[b.keyId]=i()),j[this.options.name].add(this)}m(t);var e=s(p.prototype,t.methods);if(e)throw new Error("`"+e+"` method is not allowed.");return n.options=t,n.prototype=y.create(p.prototype,y.extend(t.methods||{},{options:t})),Object.setPrototypeOf(n,d.prototype),n}function m(t){t.props=y.union(t.props,y.keys(t.defaults))}var v,y=e(1),g=e(2),w=Array.prototype.slice,j={},b={baseUrl:"",keyId:"id",redraw:!1,store:g.request};Object.setPrototypeOf=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t};var k=y.create({request:function(t,n,e,i){var o={method:t,url:n,data:e||{},serialize:this.serializer,deserialize:this.deserializer,config:this.config};return i&&y.assign(o,i),b.store(o)},config:function(t){t.setRequestHeader("Content-Type","application/json")},serializer:function(t){return JSON.stringify(t instanceof p?t.getCopy():t)},deserializer:function(t){return JSON.parse(t)},get:function(t,n,e){return this.request("GET",t,n,e)},post:function(t,n,e){return this.request("POST",t,n,e)},put:function(t,n,e){return this.request("PUT",t,n,e)},"delete":function(t,n,e){return this.request("DELETE",t,n,e)}});f.prototype={_init:function(t){this.collection||(this.collection=[]),this.__options||(this.__options={redraw:!1}),t&&this.opt(t)},opt:function(t,n){this.__options||this._init(),y.isPlainObject(t)?y.assign(this.__options,t):this.__options[t]=n||!0},changed:function(){(this.__options.redraw||b.redraw)&&g.redraw()},add:function(t,n,e){if(!(t instanceof p)||this.__options.model&&!(t instanceof this.__options.model))throw new Error("Can't add to collection. Argument must be a model or an instance of set model.");var i=this.get(t),o=!1;return i?i.set(t):(n?this.collection.unshift(t.getJson()):this.collection.push(t.getJson()),t.addCollection(this),o=!0),o&&!e&&this.changed(),o},addAll:function(t,n,e){y.isArray(t)||(t=[t]);var i=this,o=!1;return y.each(t,function(t){i.add(t,n,!0)&&(o=!0)}),o&&!e&&this.changed(),o},get:function(t){var n;if(t instanceof p)return this.indexOf(t.getJson())>-1?t:null;if(y.isObjectLike(t)){if(!t[b.keyId])return this.find(t)||null;t=t[b.keyId]}return n=this.find([b.keyId,t]),n||null},getAll:function(t,n){y.isArray(t)||(t=[t]);var e,i=this,o=[];return y.transform(t,function(t,o){e=i.get(o),(e||n)&&t.push(e)},o),o},remove:function(t,n){y.isArray(t)||(t=[t]);var e,i=this,o=this.size(),r=[];return o?(y.each(t,function(t){if(!t)throw new Error("Can't remove from collection. Argument must be set.");t instanceof p?r.push.apply(r,y.remove(i.collection,function(n){return y.eq(n,t.getJson())})):y.isObjectLike(t)?r.push.apply(r,y.remove(i.collection,function(n){return y.isMatch(n,t)})):r.push.apply(r,y.remove(i.collection,function(n){return e={},e[b.keyId]=t,y.isMatch(n,e)}))}),y.each(r,function(t){t.__model.removeCollection(i)}),o===this.size()||n||this.changed(),this.size()):void 0},push:function(t,n){return this.addAll(t,n)},unshift:function(t,n){return this.addAll(t,!0,n)},shift:function(t){var n=this.first();return this.remove(n,t),n},pop:function(t){var n=this.last();return this.remove(n,t),n},clear:function(t){this.remove(this.toArray(),t)}};var A=["addAll"],O=["forEach","map","find","findIndex","findLastIndex","filter","reject","every","some","invoke","maxBy","minBy","sortBy","groupBy","shuffle","size","initial","without","indexOf","lastIndexOf","difference","sample","reverse","nth","first","last","toArray","slice","orderBy","transform"];h(f.prototype,y,O,"collection","__model"),d.prototype=y.create(f.prototype,{url:function(){return b.baseUrl+(this.options.url||"/"+this.options.name.toLowerCase())},create:function(t){y.isArray(t)||(t=[t]);var n,e=this;y.each(t,function(t){if(!y.isPlainObject(t))throw new Error("Can't create model to collection. Argument must be a plain object.");n=e.get(t),n?n.set(t):new e.__options.model(t)})},loadById:function(t,n){if(console.log("Fetching by ids...",t),!t)throw new Error("Collection can't fetch. Id must be set.");var e=this,i=g.deferred(),o=[];y.isArray(t)||(t=[t]),this.transform(function(t,n){n.id()&&t.push(n.id())},o);var r=y.pullAll(t,o);return y.isEmpty(r)?(i.resolve(),y.isFunction(n)&&n(null)):k.get(this.url(),r).then(function(t){e.create(t),i.resolve(),y.isFunction(n)&&n(null)},function(t){i.reject(t),y.isFunction(n)&&n(t)}),i.promise},getById:function(t,n){var e=this,i=g.deferred();return y.isArray(t)||(t=[t]),this.loadById(t).then(function(){var o=e.getAll(t);i.resolve(o),y.isFunction(n)&&n(null,o)},function(t){i.reject(t),y.isFunction(n)&&n(t)}),i.promise},fetchWhere:function(t){}}),p.prototype={id:function(t){return t?this[b.keyId](t):this[b.keyId]()},cid:function(){return this.__cid},url:function(){return b.baseUrl+(this.options.url||"/"+this.options.name.toLowerCase())},addCollection:function(t){if(!(t instanceof f))throw new Error("Argument `collection` must be instance of Collection.");var n=t.get(this);n&&-1===y.indexOf(this.__collections,t)?this.__collections.push(t):t.add(this)},removeCollection:function(t){if(!(t instanceof f))throw new Error("Argument `collection` must be instance of Collection.");t.get(this)&&t.remove(this),y.indexOf(this.__collections,t)>-1&&y.pull(this.__collections,t)},changed:function(t,n){t||n?this.updateJson(n):this.updateJson(),(this.__options.redraw||this.options.redraw||b.redraw)&&g.redraw(),y.each(this.__collections,function(t){t.changed(this)})},set:function(t,n){var e,i=this,o=this.options.refs||{},r=t instanceof p;r||y.isPlainObject(t)?(y.each(t,function(t,n){if(i.isProp(n)&&y.isFunction(i[n]))if(y.isObjectLike(t)&&y.has(o,n))e=j[o[n]].get(t),e?(e.set(t),i[n](e,!0)):i[n](new j[o[n]](t)||null,!0);else if(r&&y.isFunction(t)){if(n===b.keyId&&i.id())return;i[n](t(),!0)}else i[n](t||null,!0)}),this.changed()):this[t](n||null)},updateJson:function(t){var n=this;if(this.__json||(this.__json={},this.__json.__model=this),t){if(!this.isProp(t))return;var e=this[t]();this.__json[t]=e instanceof p?e.getJson():e}else y.each(this,function(t,e){n.isProp(e)&&y.isFunction(t)&&(t=t(),t&&!y.isNull(t)&&(n.__json[e]=t instanceof p?t.getJson():t))})},get:function(t){return t?this[t]():this.getCopy()},getJson:function(){return this.__json||this.updateJson(),this.__json},getCopy:function(){var t=this,n={};return y.each(this.getJson(),function(e,i){t.isProp(i)&&(e.__model&&e.__model instanceof p?n[i]=e.__model.get():n[i]=e)}),n},opt:function(t,n){y.isPlainObject(t)?y.assign(this.__options,t):this.__options[t]=n||!0},save:function(t){var n=this,e=g.deferred(),i=this.id()?k.put:k.post;return i.call(k,this.url(),this).then(function(i){n.set(i),e.resolve(n),y.isFunction(t)&&t(null,n)},function(n){e.reject(n),y.isFunction(t)&&t(n)}),e.promise},fetch:function(t){var n=this,e=g.deferred(),i=this.id();return k.get(this.url()+(i?"/"+i:"")).then(function(i){n.set(i),e.resolve(n),y.isFunction(t)&&t(null,n)},function(n){e.reject(n),y.isFunction(t)&&t(n)}),e.promise},remove:function(t,n){var e=this,i=g.deferred(),o=this.id(),r=function(t){y.each(e.__collections,function(t){t.remove(e)}),i.resolve(),y.isFunction(n)&&n(null)};return t===!0?r():(n=t,k["delete"](this.url()+(o?"/"+o:"")).then(r,function(t){i.reject(t),y.isFunction(n)&&n(t)})),i.promise},isNew:function(){return!this.id()},isProp:function(t){return y.indexOf(this.options.props,t)>-1}};var I=["save","remove"],x=["has","keys","values","invert","pick","omit"];h(p.prototype,y,x,"__json"),n.model=function(t,n){if(t=t||{},n=n||{},!t.name)throw new Error("Model name must be set.");var e=j[t.name]=_(t);return e._init(y.assign({redraw:!1,model:e},n)),e},n.config=function(t){y.extend(b,t),o()},n.Collection=f,n.prop=i,n.request=k,v=function(){return n}.call(n,e,n,t),!(void 0!==v&&(t.exports=v)),"undefined"!=typeof window&&(window.md=n)},function(t,n){t.exports=_},function(t,n){t.exports=m}]);