/**
 * mithril-data v0.1.0
 * A model framework for your Mithril application.
 * 
 * (c) 2016 Kevin Villanueva
 * License: MIT
 */
!function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return t[o].call(i.exports,i,i.exports,e),i.loaded=!0,i.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){function o(){v.methods&&s(f.prototype,v.methods),v.controllerMethods&&s(h.prototype,v.controllerMethods)}function i(t,e,n,o){var i=m.prop(t);return 2===arguments.length?(o=e,e=null):3===arguments.length&&(o=n,n=null),o?function(t,r){var s,c=e.options.refs,u=y.call(arguments);if(_.isObject(t)&&_.has(c,n)){var a=g[c[n]].get(t);a?a.set(t):a=new g[c[n]](t)||null,u[0]=t=a}return s=i.apply(null,u),u.length&&!r&&o.call(e,t,n),s}:i}function r(t,e,n){var o,i=!1;return _.each(_.keys(e),function(e){_.hasIn(t,e)&&(i||(i=!0,o=e))}),i?o:i}function s(t,e){var n=r(t,e);if(n)throw new Error("`"+n+"` method / property is not allowed.");_.extend(t,e)}function c(t,e){return _.isArray(t)?(_.each(t,function(n,o){n[e]&&(t[o]=n[e])}),t):t?t[e]||t:t}function u(t,e){return function(n){return t(n?n[e]||n:n)}}function a(t,e,n,o,i){_.each(n,function(n){if(e[n])switch(e[n].length){case 1:t[n]=function(){var t=e[n](this[o]);return t!==this[o]?c(t,i):t};break;case 2:t[n]=function(t){_.isFunction(t)&&(t=u(t,i));var r=e[n](this[o],t);return r!==this[o]?c(r,i):r};break;case 3:t[n]=function(t,r){_.isFunction(r)&&(t=u(r,i));var s=e[n](this[o],t,r);return s!==this[o]?c(s,i):s};break;default:t[n]=function(){var t,r=y.call(arguments);return r.unshift(this[o]),t=e[n].apply(e,r),t!==this[o]?c(t,i):t}}})}function l(t){this._init(t)}function h(){}function f(){this.__options={redraw:!1},this.__collections=[]}function d(t){function e(e){var n,o=this,r=e||{},s=t.refs||{},c=t.props||{};if(_.isPlainObject(c))props=_.keys(c);else{if(!_.isArray(c))throw new Error("`props` must be a plain object or array.");props=c,c={}}f.call(this),props&&_.isArray(props)&&(_.each(props,function(t){if(!(_.startsWith(t,"__")||"id"===t&&t!==v.keyId)){if(_.hasIn(o,t)&&"id"!==t)throw new Error("`"+t+"` property field is not allowed.");_.isObject(r[t])&&_.has(s,t)?(n=g[s[t]].get(r[t]),n?(n.set(r[t]),o[t]=i(n,o,t,o.changed)):o[t]=i(new g[s[t]](r[t])||null,o,t,o.changed)):o[t]=i(r[t]||c[t]||null,o,t,o.changed)}}),_.has(this,v.keyId)||(this[v.keyId]=i()),g[this.options.name].add(this))}var n=r(f.prototype,t.methods);if(n)throw new Error("`"+n+"` method is not allowed.");return e.prototype=_.create(f.prototype,_.extend(t.methods||{},{options:t})),Object.setPrototypeOf(e,h.prototype),e}var p,_=n(1),m=n(2),y=Array.prototype.slice,g={},v={baseUrl:"",keyId:"id",redraw:!1,store:m.request};Object.setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t};var w=_.create({request:function(t,e,n,o){var i={method:t,url:e,data:n||{},serialize:this.serializer,deserialize:this.deserializer,config:this.config,background:!0};return o&&_.assign(i,o),v.store(i)},config:function(t){t.setRequestHeader("Content-Type","application/json")},serializer:function(t){return JSON.stringify(t instanceof f?t.getCopy():t)},deserializer:function(t){return JSON.parse(t)},get:function(t,e,n){return this.request("GET",t,e,n)},post:function(t,e,n){return this.request("POST",t,e,n)},put:function(t,e,n){return this.request("PUT",t,e,n)},"delete":function(t,e,n){return this.request("DELETE",t,e,n)}});l.prototype={_init:function(t){this.collection||(this.collection=[]),this.__options||(this.__options={redraw:!1}),t&&this.opt(t)},opt:function(t,e){this.__options||this._init(),_.isPlainObject(t)?_.assign(this.__options,t):this.__options[t]=e||!0},changed:function(t){(this.__options.redraw||v.redraw)&&(m.redraw(),console.log("Redrawn",this.name))},get:function(t){var e;if(t instanceof f)return this.indexOf(t.getJson())>-1?t:null;if(_.isObject(t)){if(!t[v.keyId])return this.find(t)||null;t=t[v.keyId]}return e=this.find([v.keyId,t]),e||null},add:function(t,e){_.isArray(t)||(t=[t]);var n=this,o=!1;return _.each(t,function(t){if(n.__options.model&&!(t instanceof n.__options.model))throw new Error("Can't add to collection. Argument must be instance of model set.");if(!(t instanceof f))throw new Error("Can't add to collection. Argument must be a model.");var i=n.get(t);i?i.set(t):(e?n.collection.unshift(t.getJson()):n.collection.push(t.getJson()),t.addCollection(n),o=!0)}),o&&this.changed(t),this.size()},remove:function(t){_.isArray(t)||(t=[t]);var e,n=this,o=this.size(),i=[];return _.each(t,function(t){if(!t)throw new Error("Can't remove from collection. Argument must not be set.");t instanceof f?i.push.apply(i,_.remove(n.collection,function(e){return _.eq(e,t.getJson())})):_.isObject(t)?i.push.apply(i,_.remove(n.collection,function(e){return _.isMatch(e,t)})):i.push.apply(i,_.remove(n.collection,function(n){return e={},e[v.keyId]=t,_.isMatch(n,e)}))}),_.each(i,function(t){t.__model.removeCollection(n)}),o!==this.size()&&this.changed(t),this.size()},push:function(t){return this.add(t)},unshift:function(t){return this.add(t,!0)},shift:function(){return this.remove(this.first())},pop:function(){return this.remove(this.last())}};var b=["forEach","map","find","findIndex","findLastIndex","filter","reject","every","some","invoke","maxBy","minBy","sortBy","groupBy","shuffle","size","initial","without","indexOf","lastIndexOf","difference","sample","reverse","nth","first","last","toArray"];a(l.prototype,_,b,"collection","__model"),h.prototype=_.create(l.prototype,{loadById:function(t,e){console.log("Loading by id...",t)},getById:function(t,e){console.log("Getting by id...",t)}}),f.prototype={id:function(t){return t?this[v.keyId](t):this[v.keyId]()},url:function(){return v.baseUrl+(this.options.url||"/"+this.options.name.toLowerCase())},addCollection:function(t){if(!(t instanceof l))throw new Error("Argument `collection` must be instance of Collection.");var e=t.get(this);e&&-1===_.indexOf(this.__collections,t)?this.__collections.push(t):t.add(this)},removeCollection:function(t){if(!(t instanceof l))throw new Error("Argument `collection` must be instance of Collection.");t.get(this)&&t.remove(this),_.indexOf(this.__collections,t)>-1&&_.pull(this.__collections,t)},changed:function(t,e){t||e?this.updateJson(e):this.updateJson(),(this.__options.redraw||this.options.redraw||v.redraw)&&m.redraw(),_.each(this.__collections,function(t){t.changed(this)})},set:function(t,e){var n,o=this,i=this.options.refs||{},r=t instanceof f;r||_.isPlainObject(t)?(_.each(t,function(t,e){if(!_.startsWith(e,"__")&&_.isFunction(o[e]))if(_.isObject(t)&&_.has(i,e))n=g[i[e]].get(t),n?(n.set(t),o[e](n,!0)):o[e](new g[i[e]](t)||null,!0);else if(r&&_.isFunction(t)){if(e===v.keyId&&o.id())return;o[e](t(),!0)}else o[e](t||null,!0)}),this.changed()):this[t](e||null)},updateJson:function(t){var e=this;if(this.__json||(this.__json={},this.__json.__model=this),t){if(_.startsWith(t,"__"))return;var n=this[t]();this.__json[t]=n instanceof f?n.getJson():n}else _.each(this,function(t,n){_.isFunction(t)&&!_.startsWith(n,"__")&&(t=t(),t&&!_.isNull(t)&&(e.__json[n]=t instanceof f?t.getJson():t))})},get:function(t){return t?this[t]():this.getCopy()},getJson:function(){return this.__json||this.updateJson(),this.__json},getCopy:function(){var t={};return _.each(this.getJson(),function(e,n){_.startsWith(n,"__")||(e.__model&&e.__model instanceof f?t[n]=e.__model.get():t[n]=e)}),t},opt:function(t,e){_.isObject(t)?_.assign(this.__options,t):this.__options[t]=e||!0},save:function(t){var e=this,n=m.deferred(),o=this.id()?w.put:w.post;return o.call(w,this.url(),this).then(function(o){console.log("save",o),e.set(o),n.resolve(e),t&&t(null,e)},function(e){n.reject(e),t&&t(e)}),n.promise},fetch:function(t){var e=this,n=m.deferred(),o=this.id();return w.get(this.url()+(o?"/"+o:"")).then(function(o){console.log("fetch",o),e.set(o),n.resolve(e),t&&t(null,e)},function(e){n.reject(e),t&&t(e)}),n.promise},remove:function(t){var e=this,n=m.deferred(),o=this.id();return w["delete"](this.url()+(o?"/"+o:"")).then(function(o){_.each(e.__collections,function(t){t.remove(e)}),n.resolve(),t&&t(null)},function(e){n.reject(e),t&&t(e)}),n.promise}};var j=["has","keys","values","invert","pick","omit","toArray"];a(f.prototype,_,j,"__json"),e.model=function(t,e){if(t=t||{},e=e||{},!t.name)throw new Error("Model name must be set.");var n=g[t.name]=d(t);return n._init(_.assign({redraw:!1,model:n},e)),n},e.config=function(t){_.extend(v,t),o()},e.Collection=l,e.prop=i,e.request=w,p=function(){return e}.call(e,n,e,t),!(void 0!==p&&(t.exports=p)),"undefined"!=typeof window&&(window.md=e)},function(t,e){t.exports=_},function(t,e){t.exports=m}]);